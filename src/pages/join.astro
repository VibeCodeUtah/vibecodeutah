---
import MainLayout from "@/layouts/MainLayout.astro";
import Section from "@components/Section.astro";
import { SITE } from "@data/constants";
import teams from "@data/teams";
import { Rocket, Users, Lightbulb, Mail, Phone, ChevronRight, Star, Sparkles } from "lucide-astro";

// Form submits to our API which saves to Supabase
const formAction = "/api/register";

// Get adoptable teams
const adoptableTeams = teams.filter(t => t.isExample);

// Check if a team was pre-selected via query param
const selectedTeamId = Astro.url.searchParams.get('team');
const selectedTeam = selectedTeamId ? teams.find(t => t.id === selectedTeamId) : null;
---

<MainLayout
  title={`Join the Hackathon | ${SITE.title}`}
  customDescription="Register your team for Vibe Code Utah - the AI-powered hackathon building solutions that matter."
>
  <!-- Hero -->
  <Section
    title="Join the Hackathon"
    subtitle="Register your team and start building something that matters"
    gradient="purple"
    id="join-hero"
  />

  <div class="max-w-4xl mx-auto px-4 md:px-8 pb-20 -mt-8">
    <!-- Why Join Cards -->
    <div class="grid md:grid-cols-3 gap-4 mb-12">
      <div class="flex items-start gap-4 p-5 rounded-xl bg-white dark:bg-neutral-800 border border-neutral-200 dark:border-neutral-700">
        <div class="shrink-0 w-10 h-10 rounded-lg bg-cyan-100 dark:bg-cyan-500/20 flex items-center justify-center text-cyan-600 dark:text-cyan-400">
          <Rocket size={20} />
        </div>
        <div>
          <h3 class="font-bold text-neutral-900 dark:text-white mb-1">Build with AI</h3>
          <p class="text-sm text-neutral-600 dark:text-neutral-400">Use Cursor, Claude, ChatGPT - whatever tools help you ship</p>
        </div>
      </div>

      <div class="flex items-start gap-4 p-5 rounded-xl bg-white dark:bg-neutral-800 border border-neutral-200 dark:border-neutral-700">
        <div class="shrink-0 w-10 h-10 rounded-lg bg-purple-100 dark:bg-purple-500/20 flex items-center justify-center text-purple-600 dark:text-purple-400">
          <Users size={20} />
        </div>
        <div>
          <h3 class="font-bold text-neutral-900 dark:text-white mb-1">Any Skill Level</h3>
          <p class="text-sm text-neutral-600 dark:text-neutral-400">No PhD required. Just bring an idea and enthusiasm</p>
        </div>
      </div>

      <div class="flex items-start gap-4 p-5 rounded-xl bg-white dark:bg-neutral-800 border border-neutral-200 dark:border-neutral-700">
        <div class="shrink-0 w-10 h-10 rounded-lg bg-orange-100 dark:bg-orange-500/20 flex items-center justify-center text-orange-600 dark:text-orange-400">
          <Lightbulb size={20} />
        </div>
        <div>
          <h3 class="font-bold text-neutral-900 dark:text-white mb-1">Real Impact</h3>
          <p class="text-sm text-neutral-600 dark:text-neutral-400">Build software that actually helps people</p>
        </div>
      </div>
    </div>

    <!-- Registration Form -->
    <div class="bg-white dark:bg-neutral-800 rounded-2xl border border-neutral-200 dark:border-neutral-700 shadow-xl overflow-hidden">
      <!-- Form Header -->
      <div class="bg-gradient-to-r from-cyan-500 via-purple-500 to-orange-500 p-6 text-white">
        <h2 class="text-2xl font-bold mb-1">Team Registration</h2>
        <p class="text-white/80">Fill out the form below to register your team</p>
      </div>

      <!-- Form Body -->
      <form
        action={formAction}
        method="POST"
        class="p-6 md:p-8 space-y-6"
        id="registration-form"
      >
        <!-- Hidden field to identify form type -->
        <input type="hidden" name="_subject" value="New Team Registration - Vibe Code Utah" />
        <input type="hidden" name="adopted-team-id" id="adopted-team-id" value={selectedTeamId || ""} />

        <!-- Team Selection: Adopt or Create -->
        <div class="space-y-4">
          <label class="block text-sm font-bold text-neutral-700 dark:text-neutral-200">
            How would you like to join?
          </label>

          <div class="grid md:grid-cols-2 gap-4">
            <!-- Adopt a Team Option -->
            <label
              class={`team-option-card relative flex flex-col p-5 rounded-xl border-2 cursor-pointer transition-all duration-300 ${selectedTeam ? 'border-purple-500 bg-purple-50 dark:bg-purple-500/10' : 'border-neutral-200 dark:border-neutral-600 hover:border-purple-300 dark:hover:border-purple-500/50'}`}
            >
              <input
                type="radio"
                name="join-type"
                value="adopt"
                class="sr-only"
                checked={!!selectedTeam}
                id="join-adopt"
              />
              <div class="flex items-center gap-3 mb-3">
                <div class="w-10 h-10 rounded-lg bg-gradient-to-r from-cyan-500 via-purple-500 to-orange-500 flex items-center justify-center text-white">
                  <Star size={20} />
                </div>
                <div>
                  <span class="font-bold text-neutral-900 dark:text-white">Adopt a Team</span>
                  <span class="ml-2 px-2 py-0.5 text-xs font-semibold rounded-full bg-purple-100 dark:bg-purple-500/20 text-purple-600 dark:text-purple-400">
                    {adoptableTeams.length} available
                  </span>
                </div>
              </div>
              <p class="text-sm text-neutral-600 dark:text-neutral-400">
                Grab an existing idea with a cool name and project pitch already set up!
              </p>
              <div class="absolute top-3 right-3 w-5 h-5 rounded-full border-2 border-purple-500 flex items-center justify-center check-indicator">
                <div class="w-2.5 h-2.5 rounded-full bg-purple-500 scale-0 transition-transform"></div>
              </div>
            </label>

            <!-- Create Your Own Option -->
            <label
              class={`team-option-card relative flex flex-col p-5 rounded-xl border-2 cursor-pointer transition-all duration-300 ${!selectedTeam ? 'border-orange-500 bg-orange-50 dark:bg-orange-500/10' : 'border-neutral-200 dark:border-neutral-600 hover:border-orange-300 dark:hover:border-orange-500/50'}`}
            >
              <input
                type="radio"
                name="join-type"
                value="create"
                class="sr-only"
                checked={!selectedTeam}
                id="join-create"
              />
              <div class="flex items-center gap-3 mb-3">
                <div class="w-10 h-10 rounded-lg bg-gradient-to-r from-orange-500 to-yellow-500 flex items-center justify-center text-white">
                  <Sparkles size={20} />
                </div>
                <span class="font-bold text-neutral-900 dark:text-white">Create Your Own</span>
              </div>
              <p class="text-sm text-neutral-600 dark:text-neutral-400">
                Start fresh with your own team name and project idea!
              </p>
              <div class="absolute top-3 right-3 w-5 h-5 rounded-full border-2 border-orange-500 flex items-center justify-center check-indicator">
                <div class="w-2.5 h-2.5 rounded-full bg-orange-500 scale-0 transition-transform"></div>
              </div>
            </label>
          </div>
        </div>

        <!-- Adopt Team Selector (shown when adopting) -->
        <div id="adopt-selector" class={selectedTeam ? '' : 'hidden'}>
          <label for="adopt-team" class="block text-sm font-bold text-neutral-700 dark:text-neutral-200 mb-2">
            Select a Team to Adopt <span class="text-red-500">*</span>
          </label>
          <select
            name="adopt-team"
            id="adopt-team"
            class="w-full px-4 py-3 rounded-xl border-2 border-neutral-200 dark:border-neutral-600 bg-neutral-50 dark:bg-neutral-900 text-neutral-900 dark:text-white focus:border-purple-500 dark:focus:border-purple-400 focus:ring-4 focus:ring-purple-500/20 outline-none transition-all"
          >
            <option value="">Choose a team...</option>
            {adoptableTeams.map(team => (
              <option
                value={team.id}
                selected={team.id === selectedTeamId}
                data-name={team.name}
                data-pitch={team.elevatorPitch}
                data-project={team.projectName}
              >
                {team.name} ({team.category})
              </option>
            ))}
          </select>

          <!-- Selected Team Preview -->
          {selectedTeam && (
            <div id="team-preview" class="mt-4 p-4 rounded-xl bg-gradient-to-r from-cyan-500/10 via-purple-500/10 to-orange-500/10 border border-purple-300 dark:border-purple-500/50">
              <div class="flex items-start gap-4">
                <img
                  src={selectedTeam.tokenImage}
                  alt={selectedTeam.name}
                  class="w-16 h-16 rounded-full object-cover ring-2 ring-purple-400"
                  id="preview-image"
                />
                <div class="flex-1">
                  <h4 class="font-bold text-neutral-900 dark:text-white" id="preview-name">{selectedTeam.name}</h4>
                  <p class="text-sm text-purple-600 dark:text-purple-400 mb-1" id="preview-project">Project: {selectedTeam.projectName}</p>
                  <p class="text-sm text-neutral-600 dark:text-neutral-400 line-clamp-2" id="preview-pitch">{selectedTeam.elevatorPitch}</p>
                </div>
              </div>
            </div>
          )}
        </div>

        <!-- Team Name (shown when creating own team) -->
        <div id="team-name-section" class={selectedTeam ? 'hidden' : ''}>
          <label for="team-name" class="block text-sm font-bold text-neutral-700 dark:text-neutral-200 mb-2">
            Team Name <span class="text-red-500">*</span>
          </label>
          <input
            type="text"
            name="team-name"
            id="team-name"
            class="w-full px-4 py-3 rounded-xl border-2 border-neutral-200 dark:border-neutral-600 bg-neutral-50 dark:bg-neutral-900 text-neutral-900 dark:text-white focus:border-purple-500 dark:focus:border-purple-400 focus:ring-4 focus:ring-purple-500/20 outline-none transition-all text-lg"
            placeholder="The Hot Yetis, Hungry Hippos, etc."
          />
          <p class="mt-2 text-sm text-neutral-500 dark:text-neutral-400">Get creative with it!</p>
        </div>

        <!-- Email & Phone -->
        <div class="grid md:grid-cols-2 gap-6">
          <div>
            <label for="email" class="block text-sm font-bold text-neutral-700 dark:text-neutral-200 mb-2">
              <Mail class="inline w-4 h-4 mr-1" />
              Email <span class="text-red-500">*</span>
            </label>
            <input
              type="email"
              name="email"
              id="email"
              required
              class="w-full px-4 py-3 rounded-xl border-2 border-neutral-200 dark:border-neutral-600 bg-neutral-50 dark:bg-neutral-900 text-neutral-900 dark:text-white focus:border-purple-500 dark:focus:border-purple-400 focus:ring-4 focus:ring-purple-500/20 outline-none transition-all"
              placeholder="your@email.com"
            />
          </div>

          <div>
            <label for="phone" class="block text-sm font-bold text-neutral-700 dark:text-neutral-200 mb-2">
              <Phone class="inline w-4 h-4 mr-1" />
              Phone
            </label>
            <input
              type="tel"
              name="phone"
              id="phone"
              class="w-full px-4 py-3 rounded-xl border-2 border-neutral-200 dark:border-neutral-600 bg-neutral-50 dark:bg-neutral-900 text-neutral-900 dark:text-white focus:border-purple-500 dark:focus:border-purple-400 focus:ring-4 focus:ring-purple-500/20 outline-none transition-all"
              placeholder="(555) 123-4567"
            />
          </div>
        </div>

        <!-- Team Members -->
        <div>
          <label for="team-members" class="block text-sm font-bold text-neutral-700 dark:text-neutral-200 mb-2">
            Team Members <span class="text-red-500">*</span>
          </label>
          <textarea
            name="team-members"
            id="team-members"
            required
            rows="3"
            class="w-full px-4 py-3 rounded-xl border-2 border-neutral-200 dark:border-neutral-600 bg-neutral-50 dark:bg-neutral-900 text-neutral-900 dark:text-white focus:border-purple-500 dark:focus:border-purple-400 focus:ring-4 focus:ring-purple-500/20 outline-none transition-all resize-y"
            placeholder="Sarah Chen&#10;Marcus Johnson&#10;Priya Patel"
          ></textarea>
          <p class="mt-2 text-sm text-neutral-500 dark:text-neutral-400">One name per line. Solo hackers welcome too!</p>
        </div>

        <!-- Project Idea (shown when creating own team) -->
        <div id="project-idea-section" class={selectedTeam ? 'hidden' : ''}>
          <label for="project-idea" class="block text-sm font-bold text-neutral-700 dark:text-neutral-200 mb-2">
            Your Idea (Elevator Pitch)
          </label>
          <textarea
            name="project-idea"
            id="project-idea"
            rows="4"
            class="w-full px-4 py-3 rounded-xl border-2 border-neutral-200 dark:border-neutral-600 bg-neutral-50 dark:bg-neutral-900 text-neutral-900 dark:text-white focus:border-purple-500 dark:focus:border-purple-400 focus:ring-4 focus:ring-purple-500/20 outline-none transition-all resize-y"
            placeholder="What problem are you solving? Who does it help? Don't worry if it's rough - that's what the hackathon is for!"
          ></textarea>
          <p class="mt-2 text-sm text-neutral-500 dark:text-neutral-400">Optional but helps us match you with mentors</p>
        </div>

        <!-- Submit Button -->
        <div class="pt-4">
          <button
            type="submit"
            class="w-full group relative overflow-hidden rounded-xl px-8 py-4 text-lg font-bold transition-all duration-300 hover:scale-[1.02] hover:shadow-xl"
          >
            <div class="absolute inset-0 bg-gradient-to-r from-cyan-500 via-purple-500 to-orange-500"></div>
            <div class="absolute inset-0 bg-gradient-to-r from-transparent via-white/20 to-transparent -translate-x-full group-hover:translate-x-full transition-transform duration-700"></div>
            <span class="relative z-10 flex items-center justify-center gap-2 text-white">
              Register My Team
              <ChevronRight class="w-5 h-5 group-hover:translate-x-1 transition-transform" />
            </span>
          </button>
        </div>
      </form>
    </div>

    <!-- Contact Info -->
    <div class="mt-8 text-center">
      <p class="text-neutral-600 dark:text-neutral-400">
        Questions? Email us at <a href="mailto:hello@vibecodeutah.com" class="font-semibold text-purple-600 dark:text-purple-400 hover:underline">hello@vibecodeutah.com</a>
      </p>
    </div>
  </div>
</MainLayout>

<script define:vars={{ teamsData: adoptableTeams }}>
  document.addEventListener('DOMContentLoaded', () => {
    const joinAdopt = document.getElementById('join-adopt');
    const joinCreate = document.getElementById('join-create');
    const adoptSelector = document.getElementById('adopt-selector');
    const teamNameSection = document.getElementById('team-name-section');
    const projectIdeaSection = document.getElementById('project-idea-section');
    const adoptTeamSelect = document.getElementById('adopt-team');
    const adoptedTeamIdInput = document.getElementById('adopted-team-id');
    const teamNameInput = document.getElementById('team-name');
    const optionCards = document.querySelectorAll('.team-option-card');

    // Team data from server
    const teams = teamsData;

    function updateOptionCardStyles() {
      optionCards.forEach(card => {
        const radio = card.querySelector('input[type="radio"]');
        const isAdopt = radio.id === 'join-adopt';
        const checkDot = card.querySelector('.check-indicator div');

        if (radio.checked) {
          card.classList.remove('border-neutral-200', 'dark:border-neutral-600');
          card.classList.add(
            isAdopt ? 'border-purple-500' : 'border-orange-500',
            isAdopt ? 'bg-purple-50' : 'bg-orange-50',
            isAdopt ? 'dark:bg-purple-500/10' : 'dark:bg-orange-500/10'
          );
          checkDot.classList.add('scale-100');
          checkDot.classList.remove('scale-0');
        } else {
          card.classList.add('border-neutral-200', 'dark:border-neutral-600');
          card.classList.remove(
            'border-purple-500', 'border-orange-500',
            'bg-purple-50', 'bg-orange-50',
            'dark:bg-purple-500/10', 'dark:bg-orange-500/10'
          );
          checkDot.classList.remove('scale-100');
          checkDot.classList.add('scale-0');
        }
      });
    }

    function showAdoptMode() {
      adoptSelector?.classList.remove('hidden');
      teamNameSection?.classList.add('hidden');
      projectIdeaSection?.classList.add('hidden');
      if (teamNameInput) teamNameInput.removeAttribute('required');
    }

    function showCreateMode() {
      adoptSelector?.classList.add('hidden');
      teamNameSection?.classList.remove('hidden');
      projectIdeaSection?.classList.remove('hidden');
      if (teamNameInput) teamNameInput.setAttribute('required', 'required');
      if (adoptedTeamIdInput) adoptedTeamIdInput.value = '';
    }

    function updateTeamPreview(teamId) {
      const team = teams.find(t => t.id === teamId);
      let preview = document.getElementById('team-preview');

      if (!team) {
        if (preview) preview.remove();
        if (adoptedTeamIdInput) adoptedTeamIdInput.value = '';
        return;
      }

      if (adoptedTeamIdInput) adoptedTeamIdInput.value = teamId;

      if (!preview) {
        preview = document.createElement('div');
        preview.id = 'team-preview';
        preview.className = 'mt-4 p-4 rounded-xl bg-gradient-to-r from-cyan-500/10 via-purple-500/10 to-orange-500/10 border border-purple-300 dark:border-purple-500/50';
        adoptSelector?.appendChild(preview);
      }

      preview.innerHTML = `
        <div class="flex items-start gap-4">
          <img
            src="${team.tokenImage}"
            alt="${team.name}"
            class="w-16 h-16 rounded-full object-cover ring-2 ring-purple-400"
          />
          <div class="flex-1">
            <h4 class="font-bold text-neutral-900 dark:text-white">${team.name}</h4>
            <p class="text-sm text-purple-600 dark:text-purple-400 mb-1">Project: ${team.projectName}</p>
            <p class="text-sm text-neutral-600 dark:text-neutral-400 line-clamp-2">${team.elevatorPitch}</p>
          </div>
        </div>
      `;
    }

    // Event listeners
    joinAdopt?.addEventListener('change', () => {
      showAdoptMode();
      updateOptionCardStyles();
    });

    joinCreate?.addEventListener('change', () => {
      showCreateMode();
      updateOptionCardStyles();
    });

    adoptTeamSelect?.addEventListener('change', (e) => {
      updateTeamPreview(e.target.value);
    });

    // Initialize styles
    updateOptionCardStyles();
  });
</script>

<style>
  .team-option-card {
    transition: all 0.3s ease;
  }

  .team-option-card:hover {
    transform: translateY(-2px);
  }

  .check-indicator div {
    transition: transform 0.2s ease;
  }

  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>
