---
import MainLayout from "@/layouts/MainLayout.astro";
import { supabase } from "@/lib/supabase";
import { SITE } from "@data/constants";
import { Users, DollarSign, Mail, LogOut, RefreshCw, Check, X, Clock } from "lucide-astro";

export const prerender = false;

// Check authentication
const { data: { session } } = await supabase.auth.getSession();
if (!session) {
  return Astro.redirect('/admin/login');
}

// Fetch data
const { data: registrations, error: regError } = await supabase
  .from('team_registrations')
  .select('*')
  .order('created_at', { ascending: false });

const { data: donations, error: donError } = await supabase
  .from('donation_inquiries')
  .select('*')
  .order('created_at', { ascending: false });

const { data: contacts, error: conError } = await supabase
  .from('contact_submissions')
  .select('*')
  .order('created_at', { ascending: false });

// Stats
const stats = {
  teams: registrations?.length || 0,
  pending: registrations?.filter(r => r.status === 'pending').length || 0,
  donations: donations?.length || 0,
  contacts: contacts?.filter(c => c.status === 'unread').length || 0,
};
---

<MainLayout title={`Admin Dashboard | ${SITE.title}`}>
  <div class="max-w-7xl mx-auto px-4 py-8">
    <!-- Header -->
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-8">
      <div>
        <h1 class="text-3xl font-black text-neutral-900 dark:text-white">Admin Dashboard</h1>
        <p class="text-neutral-600 dark:text-neutral-400">Manage registrations and inquiries</p>
      </div>
      <div class="flex items-center gap-3">
        <button
          onclick="window.location.reload()"
          class="flex items-center gap-2 px-4 py-2 rounded-lg bg-neutral-100 dark:bg-neutral-800 text-neutral-700 dark:text-neutral-300 hover:bg-neutral-200 dark:hover:bg-neutral-700 transition-all"
        >
          <RefreshCw size={16} />
          Refresh
        </button>
        <button
          id="logout-btn"
          class="flex items-center gap-2 px-4 py-2 rounded-lg bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-400 hover:bg-red-200 dark:hover:bg-red-900/50 transition-all"
        >
          <LogOut size={16} />
          Logout
        </button>
      </div>
    </div>

    <!-- Stats Cards -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
      <div class="p-5 rounded-xl bg-white dark:bg-neutral-800 border border-neutral-200 dark:border-neutral-700">
        <div class="flex items-center gap-3 mb-2">
          <div class="w-10 h-10 rounded-lg bg-purple-100 dark:bg-purple-500/20 flex items-center justify-center text-purple-600 dark:text-purple-400">
            <Users size={20} />
          </div>
          <span class="text-2xl font-bold text-neutral-900 dark:text-white">{stats.teams}</span>
        </div>
        <p class="text-sm text-neutral-600 dark:text-neutral-400">Total Teams</p>
      </div>

      <div class="p-5 rounded-xl bg-white dark:bg-neutral-800 border border-neutral-200 dark:border-neutral-700">
        <div class="flex items-center gap-3 mb-2">
          <div class="w-10 h-10 rounded-lg bg-yellow-100 dark:bg-yellow-500/20 flex items-center justify-center text-yellow-600 dark:text-yellow-400">
            <Clock size={20} />
          </div>
          <span class="text-2xl font-bold text-neutral-900 dark:text-white">{stats.pending}</span>
        </div>
        <p class="text-sm text-neutral-600 dark:text-neutral-400">Pending Review</p>
      </div>

      <div class="p-5 rounded-xl bg-white dark:bg-neutral-800 border border-neutral-200 dark:border-neutral-700">
        <div class="flex items-center gap-3 mb-2">
          <div class="w-10 h-10 rounded-lg bg-green-100 dark:bg-green-500/20 flex items-center justify-center text-green-600 dark:text-green-400">
            <DollarSign size={20} />
          </div>
          <span class="text-2xl font-bold text-neutral-900 dark:text-white">{stats.donations}</span>
        </div>
        <p class="text-sm text-neutral-600 dark:text-neutral-400">Donation Inquiries</p>
      </div>

      <div class="p-5 rounded-xl bg-white dark:bg-neutral-800 border border-neutral-200 dark:border-neutral-700">
        <div class="flex items-center gap-3 mb-2">
          <div class="w-10 h-10 rounded-lg bg-cyan-100 dark:bg-cyan-500/20 flex items-center justify-center text-cyan-600 dark:text-cyan-400">
            <Mail size={20} />
          </div>
          <span class="text-2xl font-bold text-neutral-900 dark:text-white">{stats.contacts}</span>
        </div>
        <p class="text-sm text-neutral-600 dark:text-neutral-400">Unread Messages</p>
      </div>
    </div>

    <!-- Team Registrations -->
    <div class="bg-white dark:bg-neutral-800 rounded-2xl border border-neutral-200 dark:border-neutral-700 overflow-hidden mb-8">
      <div class="p-5 border-b border-neutral-200 dark:border-neutral-700">
        <h2 class="text-xl font-bold text-neutral-900 dark:text-white flex items-center gap-2">
          <Users size={20} class="text-purple-500" />
          Team Registrations
        </h2>
      </div>

      {registrations && registrations.length > 0 ? (
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="bg-neutral-50 dark:bg-neutral-900/50">
              <tr>
                <th class="px-4 py-3 text-left text-xs font-semibold text-neutral-600 dark:text-neutral-400 uppercase">Team</th>
                <th class="px-4 py-3 text-left text-xs font-semibold text-neutral-600 dark:text-neutral-400 uppercase">Email</th>
                <th class="px-4 py-3 text-left text-xs font-semibold text-neutral-600 dark:text-neutral-400 uppercase">Members</th>
                <th class="px-4 py-3 text-left text-xs font-semibold text-neutral-600 dark:text-neutral-400 uppercase">Status</th>
                <th class="px-4 py-3 text-left text-xs font-semibold text-neutral-600 dark:text-neutral-400 uppercase">Date</th>
                <th class="px-4 py-3 text-left text-xs font-semibold text-neutral-600 dark:text-neutral-400 uppercase">Actions</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-neutral-200 dark:divide-neutral-700">
              {registrations.map((reg) => (
                <tr class="hover:bg-neutral-50 dark:hover:bg-neutral-900/30 transition-colors">
                  <td class="px-4 py-4">
                    <div class="font-semibold text-neutral-900 dark:text-white">{reg.team_name}</div>
                    {reg.project_idea && (
                      <div class="text-xs text-neutral-500 dark:text-neutral-400 truncate max-w-xs" title={reg.project_idea}>
                        {reg.project_idea.substring(0, 50)}...
                      </div>
                    )}
                  </td>
                  <td class="px-4 py-4 text-sm text-neutral-600 dark:text-neutral-300">
                    <a href={`mailto:${reg.email}`} class="hover:text-purple-600 dark:hover:text-purple-400">{reg.email}</a>
                  </td>
                  <td class="px-4 py-4 text-sm text-neutral-600 dark:text-neutral-300">
                    {reg.team_members.split('\n').length} members
                  </td>
                  <td class="px-4 py-4">
                    <span class={`inline-flex px-2 py-1 rounded-full text-xs font-medium ${
                      reg.status === 'approved' ? 'bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400' :
                      reg.status === 'rejected' ? 'bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-400' :
                      'bg-yellow-100 dark:bg-yellow-900/30 text-yellow-700 dark:text-yellow-400'
                    }`}>
                      {reg.status}
                    </span>
                  </td>
                  <td class="px-4 py-4 text-sm text-neutral-500 dark:text-neutral-400">
                    {new Date(reg.created_at).toLocaleDateString()}
                  </td>
                  <td class="px-4 py-4">
                    <div class="flex items-center gap-2">
                      <button
                        data-action="approve"
                        data-id={reg.id}
                        data-table="team_registrations"
                        class="p-2 rounded-lg bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400 hover:bg-green-200 dark:hover:bg-green-900/50 transition-all"
                        title="Approve"
                      >
                        <Check size={14} />
                      </button>
                      <button
                        data-action="reject"
                        data-id={reg.id}
                        data-table="team_registrations"
                        class="p-2 rounded-lg bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-400 hover:bg-red-200 dark:hover:bg-red-900/50 transition-all"
                        title="Reject"
                      >
                        <X size={14} />
                      </button>
                    </div>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      ) : (
        <div class="p-8 text-center text-neutral-500 dark:text-neutral-400">
          No registrations yet
        </div>
      )}
    </div>

    <!-- Donation Inquiries -->
    <div class="bg-white dark:bg-neutral-800 rounded-2xl border border-neutral-200 dark:border-neutral-700 overflow-hidden">
      <div class="p-5 border-b border-neutral-200 dark:border-neutral-700">
        <h2 class="text-xl font-bold text-neutral-900 dark:text-white flex items-center gap-2">
          <DollarSign size={20} class="text-green-500" />
          Donation & Sponsor Inquiries
        </h2>
      </div>

      {donations && donations.length > 0 ? (
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="bg-neutral-50 dark:bg-neutral-900/50">
              <tr>
                <th class="px-4 py-3 text-left text-xs font-semibold text-neutral-600 dark:text-neutral-400 uppercase">Name</th>
                <th class="px-4 py-3 text-left text-xs font-semibold text-neutral-600 dark:text-neutral-400 uppercase">Email</th>
                <th class="px-4 py-3 text-left text-xs font-semibold text-neutral-600 dark:text-neutral-400 uppercase">Company</th>
                <th class="px-4 py-3 text-left text-xs font-semibold text-neutral-600 dark:text-neutral-400 uppercase">Type</th>
                <th class="px-4 py-3 text-left text-xs font-semibold text-neutral-600 dark:text-neutral-400 uppercase">Status</th>
                <th class="px-4 py-3 text-left text-xs font-semibold text-neutral-600 dark:text-neutral-400 uppercase">Date</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-neutral-200 dark:divide-neutral-700">
              {donations.map((don) => (
                <tr class="hover:bg-neutral-50 dark:hover:bg-neutral-900/30 transition-colors">
                  <td class="px-4 py-4 font-semibold text-neutral-900 dark:text-white">{don.name}</td>
                  <td class="px-4 py-4 text-sm text-neutral-600 dark:text-neutral-300">
                    <a href={`mailto:${don.email}`} class="hover:text-purple-600 dark:hover:text-purple-400">{don.email}</a>
                  </td>
                  <td class="px-4 py-4 text-sm text-neutral-600 dark:text-neutral-300">{don.company || '-'}</td>
                  <td class="px-4 py-4 text-sm text-neutral-600 dark:text-neutral-300">{don.inquiry_type}</td>
                  <td class="px-4 py-4">
                    <span class={`inline-flex px-2 py-1 rounded-full text-xs font-medium ${
                      don.status === 'confirmed' ? 'bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400' :
                      don.status === 'contacted' ? 'bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-400' :
                      don.status === 'declined' ? 'bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-400' :
                      'bg-yellow-100 dark:bg-yellow-900/30 text-yellow-700 dark:text-yellow-400'
                    }`}>
                      {don.status}
                    </span>
                  </td>
                  <td class="px-4 py-4 text-sm text-neutral-500 dark:text-neutral-400">
                    {new Date(don.created_at).toLocaleDateString()}
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      ) : (
        <div class="p-8 text-center text-neutral-500 dark:text-neutral-400">
          No donation inquiries yet
        </div>
      )}
    </div>
  </div>
</MainLayout>

<script>
  import { createClient } from '@supabase/supabase-js';

  const supabaseUrl = import.meta.env.PUBLIC_SUPABASE_URL;
  const supabaseKey = import.meta.env.PUBLIC_SUPABASE_ANON_KEY;
  const supabase = createClient(supabaseUrl, supabaseKey);

  // Logout
  document.getElementById('logout-btn')?.addEventListener('click', async () => {
    await supabase.auth.signOut();
    window.location.href = '/admin/login';
  });

  // Action buttons (approve/reject)
  document.querySelectorAll('[data-action]').forEach(btn => {
    btn.addEventListener('click', async () => {
      const action = btn.getAttribute('data-action');
      const id = btn.getAttribute('data-id');
      const table = btn.getAttribute('data-table');

      if (!id || !table) return;

      const status = action === 'approve' ? 'approved' : 'rejected';

      const { error } = await supabase
        .from(table)
        .update({ status })
        .eq('id', id);

      if (error) {
        alert('Error updating status: ' + error.message);
      } else {
        window.location.reload();
      }
    });
  });
</script>
