---
import MainLayout from "@/layouts/MainLayout.astro";
import { supabase } from "@/lib/supabase";
import { SITE } from "@data/constants";

export const prerender = false;

// Check if already logged in
const { data: { session } } = await supabase.auth.getSession();
if (session) {
  return Astro.redirect('/admin');
}
---

<MainLayout title={`Admin Login | ${SITE.title}`}>
  <div class="min-h-[80vh] flex items-center justify-center px-4 py-20">
    <div class="w-full max-w-md">
      <div class="bg-white dark:bg-neutral-800 rounded-2xl border border-neutral-200 dark:border-neutral-700 shadow-xl overflow-hidden">
        <!-- Header -->
        <div class="bg-gradient-to-r from-cyan-500 via-purple-500 to-orange-500 p-6 text-center">
          <h1 class="text-2xl font-bold text-white">Admin Login</h1>
          <p class="text-white/80 text-sm mt-1">VibeCodeUtah Dashboard</p>
        </div>

        <!-- Form -->
        <form id="login-form" class="p-6 space-y-4">
          <div>
            <label for="email" class="block text-sm font-semibold text-neutral-700 dark:text-neutral-200 mb-2">
              Email
            </label>
            <input
              type="email"
              id="email"
              name="email"
              required
              class="w-full px-4 py-3 rounded-xl border-2 border-neutral-200 dark:border-neutral-600 bg-neutral-50 dark:bg-neutral-900 text-neutral-900 dark:text-white focus:border-purple-500 dark:focus:border-purple-400 focus:ring-4 focus:ring-purple-500/20 outline-none transition-all"
              placeholder="admin@vibecodeutah.com"
            />
          </div>

          <div>
            <label for="password" class="block text-sm font-semibold text-neutral-700 dark:text-neutral-200 mb-2">
              Password
            </label>
            <input
              type="password"
              id="password"
              name="password"
              required
              class="w-full px-4 py-3 rounded-xl border-2 border-neutral-200 dark:border-neutral-600 bg-neutral-50 dark:bg-neutral-900 text-neutral-900 dark:text-white focus:border-purple-500 dark:focus:border-purple-400 focus:ring-4 focus:ring-purple-500/20 outline-none transition-all"
              placeholder="••••••••"
            />
          </div>

          <!-- Error message -->
          <div id="error-message" class="hidden p-3 rounded-lg bg-red-50 dark:bg-red-900/30 border border-red-200 dark:border-red-700 text-red-700 dark:text-red-300 text-sm">
          </div>

          <button
            type="submit"
            class="w-full py-3 px-4 rounded-xl font-bold text-white bg-gradient-to-r from-cyan-500 via-purple-500 to-orange-500 hover:scale-[1.02] transition-all disabled:opacity-50 disabled:cursor-not-allowed"
          >
            <span id="btn-text">Sign In</span>
            <span id="btn-loading" class="hidden">Signing in...</span>
          </button>
        </form>

        <div class="px-6 pb-6 text-center">
          <a href="/" class="text-sm text-neutral-500 dark:text-neutral-400 hover:text-purple-600 dark:hover:text-purple-400">
            ← Back to website
          </a>
        </div>
      </div>
    </div>
  </div>
</MainLayout>

<script>
  import { createClient } from '@supabase/supabase-js';

  const supabaseUrl = import.meta.env.PUBLIC_SUPABASE_URL;
  const supabaseKey = import.meta.env.PUBLIC_SUPABASE_ANON_KEY;
  const supabase = createClient(supabaseUrl, supabaseKey);

  const form = document.getElementById('login-form') as HTMLFormElement;
  const errorDiv = document.getElementById('error-message');
  const btnText = document.getElementById('btn-text');
  const btnLoading = document.getElementById('btn-loading');

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();

    const email = (document.getElementById('email') as HTMLInputElement).value;
    const password = (document.getElementById('password') as HTMLInputElement).value;

    // Show loading state
    btnText?.classList.add('hidden');
    btnLoading?.classList.remove('hidden');
    errorDiv?.classList.add('hidden');

    try {
      const { data, error } = await supabase.auth.signInWithPassword({
        email,
        password
      });

      if (error) {
        throw error;
      }

      // Success - redirect to admin dashboard
      window.location.href = '/admin';
    } catch (err: any) {
      // Show error
      if (errorDiv) {
        errorDiv.textContent = err.message || 'Login failed. Please try again.';
        errorDiv.classList.remove('hidden');
      }
      btnText?.classList.remove('hidden');
      btnLoading?.classList.add('hidden');
    }
  });
</script>
